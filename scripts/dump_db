#!/bin/bash
dbname=`echo $1|xargs|tr -d '\r'`
password=$2
today=`date +%Y-%m-%d`
target_path=/tmp/${dbname}.sql.gz

echo $today
echo $target_path

function load_dump() {
    chmod ugo+rw $target_path
    mysql -uroot -p$password -e "drop database if exists \`$dbname\`; create database \`$dbname\`;"
    zcat $target_path |mysql -uroot -p$password ${dbname} 
}


function dump_day() {
    wget -O $target_path http://backup.afi-sa.net/MySQL/Opac3/Daily/`date --date="$1" +%d-%m-%Y`/${dbname}_`date --date="$1" +%Y%m%d`_OPAC3_MyISAM_backup.sql.gz
    if [[ `echo "$?"` == 0 ]]; then
       load_dump $1
       echo "dump from $1 completed"
       exit 0
    fi
    
    wget -O $target_path http://backup.afi-sa.net/MySQL/Opac3/Daily/`date --date="$1" +%d-%m-%Y`/${dbname}_`date --date="$1 -1 day" +%Y%m%d`_OPAC3_MyISAM_backup.sql.gz
    if [[ `echo "$?"` == 0 ]]; then
       load_dump $1
       echo "dump from $1 completed"
       exit 0
    fi
}


dump_day $today
dump_day `date --date="$today -1 day" +%Y-%m-%d`
dump_day `date --date="$today -2 days" +%Y-%m-%d`
dump_day `date --date="$today -3 days" +%Y-%m-%d`

echo "Could not dump"
exit 1

